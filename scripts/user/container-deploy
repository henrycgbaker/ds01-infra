#!/bin/bash
# DS01 Container Deploy - Orchestrates container creation and startup
# Tier 3 Command - Combines container-create + container-start/run

set -e

# Colors
BLUE='\033[94m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

# Script paths
SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")" && pwd)"
CONTAINER_CREATE="$SCRIPT_DIR/container-create"
CONTAINER_START="$SCRIPT_DIR/container-start"
CONTAINER_RUN="$SCRIPT_DIR/container-run"

usage() {
    echo ""
    echo -e "${BOLD}DS01 Container Deploy${NC}"
    echo -e "${DIM}Tier 3 Orchestrator - Creates and starts containers in one command${NC}"
    echo ""
    echo -e "${CYAN}Usage:${NC}"
    echo "  container-deploy [name] [image] [options]"
    echo "  container-deploy                  # Interactive wizard"
    echo ""
    echo -e "${CYAN}Arguments:${NC}"
    echo "  name              Container name (optional - wizard starts if omitted)"
    echo "  image             Docker image or framework (pytorch, tensorflow)"
    echo ""
    echo -e "${CYAN}Options:${NC}"
    echo "  --guided          Show detailed explanations for beginners"
    echo "  --cpu-only        Create CPU-only container (no GPU)"
    echo "  -w, --workspace   Workspace directory (default: ~/workspace/<name>)"
    echo "  -d, --data        Additional data directory to mount"
    echo "  --background      Start in background (don't open terminal)"
    echo "  --open            Start and open terminal immediately"
    echo "  --dry-run         Show what would be created"
    echo "  -h, --help        Show this help message"
    echo ""
    echo -e "${CYAN}What this does:${NC}"
    echo "  1. Creates container (via container-create)"
    echo "  2. Prompts: Start in background or open terminal?"
    echo "  3. Starts container (via container-start or container-run)"
    echo ""
    echo -e "${CYAN}Examples:${NC}"
    echo -e "  ${DIM}# Interactive mode (recommended)${NC}"
    echo "  container-deploy"
    echo ""
    echo -e "  ${DIM}# Quick deploy with PyTorch${NC}"
    echo "  container-deploy my-project"
    echo ""
    echo -e "  ${DIM}# Deploy from custom image and open terminal${NC}"
    echo "  container-deploy my-project my-project-image --open"
    echo ""
    echo -e "  ${DIM}# Deploy in background for SSH access${NC}"
    echo "  container-deploy my-project --background"
    echo ""
    echo -e "  ${DIM}# Guided mode for beginners${NC}"
    echo "  container-deploy --guided"
    echo ""
    echo -e "${CYAN}Alternative (Tier 2 commands):${NC}"
    echo "  If you prefer step-by-step control:"
    echo -e "  1. ${GREEN}container-create <name>${NC}   # Create container"
    echo -e "  2. ${GREEN}container-run <name>${NC}      # Start and enter"
    echo ""
}

# Parse arguments
CREATE_ARGS=()
START_MODE=""  # "background", "open", or "" (prompt)
CONTAINER_NAME=""

while [[ $# -gt 0 ]]; do
    case $1 in
        --background)
            START_MODE="background"
            shift
            ;;
        --open)
            START_MODE="open"
            shift
            ;;
        -h|--help|--info)
            usage
            exit 0
            ;;
        *)
            # Pass all other args to container-create
            CREATE_ARGS+=("$1")
            # Capture container name (first positional arg that's not a flag)
            if [[ ! "$1" =~ ^- ]] && [ -z "$CONTAINER_NAME" ]; then
                CONTAINER_NAME="$1"
            fi
            shift
            ;;
    esac
done

echo ""
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BOLD}DS01 Container Deploy${NC}"
echo -e "${DIM}Ephemeral containers + Persistent workspaces${NC}"
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

# Step 1: Create container
echo -e "${BOLD}Step 1/2: Creating Container${NC}"
echo ""

if ! "$CONTAINER_CREATE" "${CREATE_ARGS[@]}"; then
    echo ""
    echo -e "${RED}âœ— Container creation failed${NC}"
    exit 1
fi

# Extract container name if we don't have it yet (interactive mode)
# In interactive mode, container-create will have created a container
# We need to figure out which one was just created
if [ -z "$CONTAINER_NAME" ]; then
    # In interactive mode, ask user for the name
    echo ""
    echo -e "${YELLOW}Note:${NC} Container created in interactive mode"
    read -p "Enter the container name to start: " CONTAINER_NAME </dev/tty

    if [ -z "$CONTAINER_NAME" ]; then
        echo -e "${RED}âœ— Container name required${NC}"
        exit 1
    fi
fi

echo ""
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BOLD}Step 2/2: Starting Container${NC}"
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

# If start mode not specified, prompt
if [ -z "$START_MODE" ]; then
    echo -e "${BOLD}How would you like to start the container?${NC}"
    echo ""
    echo -e "  ${BOLD}1)${NC} ${GREEN}Start in background${NC}"
    echo -e "     ${DIM}Container runs in background, access via SSH/IDE${NC}"
    echo -e "     ${DIM}Uses: container-start${NC}"
    echo ""
    echo -e "  ${BOLD}2)${NC} ${GREEN}Start and open terminal${NC} (recommended)"
    echo -e "     ${DIM}Opens interactive shell inside container${NC}"
    echo -e "     ${DIM}Uses: container-run${NC}"
    echo ""
    read -p "Choice [1-2, default: 2]: " CHOICE </dev/tty
    CHOICE=${CHOICE:-2}

    case $CHOICE in
        1)
            START_MODE="background"
            ;;
        2|*)
            START_MODE="open"
            ;;
    esac
    echo ""
fi

# Step 2: Start container
case $START_MODE in
    background)
        echo -e "${CYAN}Starting container in background...${NC}"
        echo ""
        if "$CONTAINER_START" "$CONTAINER_NAME"; then
            echo ""
            echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
            echo -e "${GREEN}${BOLD}âœ“ Container Deployed Successfully!${NC}"
            echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
            echo ""
            echo -e "${BOLD}Next steps:${NC}"
            echo -e "  â€¢ Access container: ${GREEN}container-run $CONTAINER_NAME${NC}"
            echo -e "  â€¢ Check status:     ${GREEN}container-list${NC}"
            echo -e "  â€¢ View stats:       ${GREEN}container-stats${NC}"
            echo ""
            echo -e "${YELLOW}ğŸ’¡ Remember:${NC} When done, free resources with: ${GREEN}container-retire $CONTAINER_NAME${NC}"
            echo ""
        else
            echo ""
            echo -e "${RED}âœ— Container start failed${NC}"
            exit 1
        fi
        ;;
    open)
        echo -e "${CYAN}Starting container and opening terminal...${NC}"
        echo ""
        # container-run will exec into the container (this script won't return until user exits)
        exec "$CONTAINER_RUN" "$CONTAINER_NAME"
        ;;
esac
