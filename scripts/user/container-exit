#!/bin/bash
# Information about exiting containers without stopping them

BLUE='\033[94m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

USERNAME=$(whoami)

get_idle_timeout() {
    local username="$1"
    local script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    local infra_root="$(dirname "$script_dir")"
    local resource_parser="$infra_root/docker/get_resource_limits.py"

    if [ -f "$resource_parser" ]; then
        python3 "$resource_parser" "$username" --idle-timeout 2>/dev/null || echo "48h"
    else
        echo "48h"
    fi
}

cat << EOF
${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}
${CYAN}${BOLD}    Exit Container (Without Stopping)${NC}
${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}

${BOLD}When attached to a container, use:${NC}

  ${GREEN}${BOLD}Ctrl+P, Ctrl+Q${NC}  â†’  Detach and leave container running

${DIM}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}

${BOLD}What happens:${NC}
  ${GREEN}âœ“${NC} Container keeps running in background
  ${GREEN}âœ“${NC} All processes continue (training, Jupyter, etc.)
  ${GREEN}âœ“${NC} You can reconnect anytime

${BOLD}Auto-stop timeout:${NC}
  ${YELLOW}$(get_idle_timeout "$USERNAME")${NC} of idle GPU time
  ${DIM}(After this period of no GPU activity, container auto-stops)${NC}

${DIM}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}

${BOLD}Reconnect later:${NC}
  ${GREEN}container-run <name>${NC}

${BOLD}Stop manually:${NC}
  ${GREEN}container-stop <name>${NC}

${BOLD}Check status:${NC}
  ${GREEN}container-list${NC}

${DIM}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}

${BOLD}Comparison:${NC}

  ${GREEN}Ctrl+P, Ctrl+Q${NC}  â†’  Exit without stopping
                      ${DIM}(Container keeps running)${NC}

  ${YELLOW}exit${NC} or ${YELLOW}Ctrl+D${NC}  â†’  Exit and stop container
                      ${DIM}(Container terminates)${NC}

${DIM}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}

${YELLOW}ðŸ’¡ Best Practices:${NC}

  â€¢ ${BOLD}For long training:${NC} Use ${GREEN}Ctrl+P, Ctrl+Q${NC} to detach
    Your job continues running

  â€¢ ${BOLD}Quick tasks:${NC} Just ${YELLOW}exit${NC} when done
    Saves resources for others

  â€¢ ${BOLD}Check before closing:${NC} Use ${GREEN}container-list${NC}
    See what's still running

${DIM}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}

${BOLD}Examples:${NC}

  ${DIM}# Start long training${NC}
  container-run my-project
  ${DIM}(in container)${NC} python train.py --epochs 100
  ${GREEN}Ctrl+P, Ctrl+Q${NC}  ${DIM}# Detach, training continues${NC}

  ${DIM}# Check on it later${NC}
  container-list  ${DIM}# See it's still running${NC}
  container-run my-project  ${DIM}# Reconnect${NC}

${DIM}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}

${RED}âš  Important:${NC}
  Containers are ${BOLD}not${NC} VMs - they share server resources
  Please stop containers when not in use:
    ${GREEN}container-stop <name>${NC}

EOF
