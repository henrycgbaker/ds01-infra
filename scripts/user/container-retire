#!/bin/bash
# DS01 Container Retire - Orchestrates container stop and removal
# Tier 3 Command - Combines container-stop + container-remove

set -e

# Colors
BLUE='\033[94m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

# Script paths
SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")" && pwd)"
INFRA_ROOT="$(dirname "$(dirname "$SCRIPT_DIR")")"
CONTAINER_STOP="$SCRIPT_DIR/container-stop"
CONTAINER_REMOVE="$SCRIPT_DIR/container-remove"

# Source interactive library (with fallback for development)
if [ -f "/usr/local/lib/interactive-select.sh" ]; then
    source /usr/local/lib/interactive-select.sh
elif [ -f "$INFRA_ROOT/scripts/lib/interactive-select.sh" ]; then
    source "$INFRA_ROOT/scripts/lib/interactive-select.sh"
else
    echo "Error: interactive-select.sh not found"
    exit 1
fi

USERNAME=$(whoami)
USER_ID=$(id -u)

usage() {
    echo ""
    echo -e "${BOLD}DS01 Container Retire${NC}"
    echo -e "${DIM}Tier 3 Orchestrator - Stops and removes containers in one command${NC}"
    echo ""
    echo -e "${CYAN}Usage:${NC}"
    echo "  container-retire [name] [options]"
    echo "  container-retire                  # Interactive mode - prompts to select"
    echo ""
    echo -e "${CYAN}Arguments:${NC}"
    echo "  name              Container name (optional - will prompt if not provided)"
    echo ""
    echo -e "${CYAN}Options:${NC}"
    echo "  --guided          Show detailed explanations for beginners"
    echo "  -f, --force       Skip all confirmation prompts"
    echo "  -i, --images      Also remove associated Docker images"
    echo "  -v, --volumes     Also remove anonymous volumes"
    echo "  --dry-run         Show what would be done"
    echo "  -h, --help        Show this help message"
    echo ""
    echo -e "${CYAN}What this does:${NC}"
    echo "  1. Stops the container (via container-stop)"
    echo "  2. Removes the container (via container-remove)"
    echo "  3. Releases GPU immediately"
    echo ""
    echo -e "${CYAN}What is preserved:${NC}"
    echo -e "  ${GREEN}âœ“${NC} Workspace files (~/workspace/<project>/)"
    echo -e "  ${GREEN}âœ“${NC} Dockerfiles (~/dockerfiles/)"
    echo -e "  ${GREEN}âœ“${NC} Docker images (unless --images flag used)"
    echo -e "  ${GREEN}âœ“${NC} Project configuration files"
    echo ""
    echo -e "${CYAN}Examples:${NC}"
    echo -e "  ${DIM}# Retire specific container${NC}"
    echo "  container-retire my-old-project"
    echo ""
    echo -e "  ${DIM}# Retire with image cleanup${NC}"
    echo "  container-retire my-old-project --images"
    echo ""
    echo -e "  ${DIM}# Interactive mode (recommended)${NC}"
    echo "  container-retire"
    echo ""
    echo -e "  ${DIM}# Skip confirmations${NC}"
    echo "  container-retire my-project --force"
    echo ""
    echo -e "${CYAN}Alternative (Tier 2 commands):${NC}"
    echo "  If you prefer step-by-step control:"
    echo -e "  1. ${GREEN}container-stop <name>${NC}    # Stop container"
    echo -e "  2. ${GREEN}container-remove <name>${NC}  # Remove container"
    echo ""
    echo -e "${YELLOW}ğŸ’¡ Use this when:${NC}"
    echo "  â€¢ Completely done with a container"
    echo "  â€¢ Want to free GPU immediately for others"
    echo "  â€¢ Need to recreate container from scratch"
    echo ""
}

# Parse arguments
CONTAINER_NAME=""
STOP_ARGS=()
REMOVE_ARGS=()
GUIDED=false
FORCE=false
DRY_RUN=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --guided)
            GUIDED=true
            STOP_ARGS+=("--guided")
            REMOVE_ARGS+=("--guided")
            shift
            ;;
        -f|--force)
            FORCE=true
            STOP_ARGS+=("--force")
            REMOVE_ARGS+=("--force")
            shift
            ;;
        -i|--images)
            REMOVE_ARGS+=("--images")
            shift
            ;;
        -v|--volumes)
            REMOVE_ARGS+=("--volumes")
            shift
            ;;
        --dry-run)
            DRY_RUN=true
            REMOVE_ARGS+=("--dry-run")
            shift
            ;;
        -h|--help|--info)
            usage
            exit 0
            ;;
        -*)
            echo -e "${RED}âœ— Unknown option: $1${NC}\n"
            usage
            exit 1
            ;;
        *)
            if [ -z "$CONTAINER_NAME" ]; then
                CONTAINER_NAME="$1"
            else
                echo -e "${RED}âœ— Too many arguments${NC}\n"
                usage
                exit 1
            fi
            shift
            ;;
    esac
done

echo ""
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BOLD}DS01 Container Retire${NC}"
echo -e "${DIM}Ephemeral containers - Retire when done${NC}"
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

if [ "$GUIDED" = true ]; then
    echo -e "${CYAN}â„¹ ${NC}${BOLD}What does retiring mean?${NC}"
    echo ""
    echo "  Retiring a container means:"
    echo -e "  â€¢ ${BOLD}Stop${NC} all running processes inside the container"
    echo -e "  â€¢ ${BOLD}Remove${NC} the container instance completely"
    echo -e "  â€¢ ${BOLD}Release${NC} GPU allocation immediately for others"
    echo ""
    echo -e "${BOLD}What stays safe:${NC}"
    echo -e "  â€¢ ${GREEN}âœ“${NC} All workspace files (~/workspace/<project>/)"
    echo -e "  â€¢ ${GREEN}âœ“${NC} Dockerfiles (~/dockerfiles/)"
    echo -e "  â€¢ ${GREEN}âœ“${NC} Docker images (your blueprints)"
    echo ""
    echo -e "${BOLD}You can recreate anytime:${NC}"
    echo -e "  ${GREEN}container-deploy <name>${NC}  ${DIM}# Recreate from image${NC}"
    echo ""
    echo -e "${YELLOW}ğŸ’¡ Think of it:${NC} Shutting down a laptop (container) but keeping your files (workspace)"
    echo ""
fi

# If no container name, prompt for selection
if [ -z "$CONTAINER_NAME" ]; then
    echo -e "${CYAN}Select container to retire:${NC}"
    echo ""
    CONTAINER_NAME=$(select_container "running")

    if [ -z "$CONTAINER_NAME" ]; then
        # No running containers, try stopped
        echo ""
        echo -e "${YELLOW}No running containers found.${NC}"
        echo ""
        CONTAINER_NAME=$(select_container "stopped")

        if [ -z "$CONTAINER_NAME" ]; then
            echo ""
            echo -e "${YELLOW}No containers to retire.${NC}"
            exit 0
        fi
    fi
    echo ""
fi

# Validate container exists
CONTAINER_TAG="${CONTAINER_NAME}._.${USER_ID}"
if ! docker ps -a --format "{{.Names}}" 2>/dev/null | grep -q "^${CONTAINER_TAG}$"; then
    echo -e "${RED}âœ— Container '$CONTAINER_NAME' not found${NC}"
    exit 1
fi

# Check if container is running or stopped
CONTAINER_STATUS=$(docker inspect -f '{{.State.Status}}' "$CONTAINER_TAG" 2>/dev/null || echo "")

if [ "$DRY_RUN" = true ]; then
    echo -e "${YELLOW}â”â”â” DRY RUN MODE â”â”â”${NC}"
    echo ""
    echo "Would retire container: ${CYAN}$CONTAINER_NAME${NC}"
    echo ""
    if [ "$CONTAINER_STATUS" = "running" ]; then
        echo -e "  ${DIM}1. Stop container${NC}"
    fi
    echo -e "  ${DIM}2. Remove container${NC}"
    echo -e "  ${DIM}3. Release GPU allocation${NC}"
    echo ""
    exit 0
fi

# Confirm retirement
if [ "$FORCE" != "true" ]; then
    echo -e "${YELLOW}âš  This will permanently retire container: ${BOLD}$CONTAINER_NAME${NC}"
    echo ""
    echo -e "${BOLD}What will happen:${NC}"
    if [ "$CONTAINER_STATUS" = "running" ]; then
        echo "  1. Container will be stopped"
        echo "  2. All running processes will be terminated"
        echo "  3. Container will be removed"
        echo "  4. GPU will be released immediately"
    else
        echo "  1. Container will be removed"
        echo "  2. GPU will be released immediately"
    fi
    echo ""
    echo -e "${BOLD}What stays safe:${NC}"
    echo -e "  â€¢ ${GREEN}Workspace files${NC} in ~/workspace/$CONTAINER_NAME/"
    echo -e "  â€¢ ${GREEN}Dockerfiles${NC} in ~/dockerfiles/"
    if [[ ! " ${REMOVE_ARGS[@]} " =~ " --images " ]]; then
        echo -e "  â€¢ ${GREEN}Docker images${NC} (use --images to remove)"
    fi
    echo ""
    read -p "Continue with retirement? [y/N]: " CONFIRM </dev/tty
    if [[ ! "$CONFIRM" =~ ^[Yy]$ ]]; then
        echo "Cancelled."
        exit 0
    fi
    echo ""
fi

# Step 1: Stop container (if running)
if [ "$CONTAINER_STATUS" = "running" ]; then
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BOLD}Step 1/2: Stopping Container${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""

    # Override container-stop's "remove container now?" prompt by adding --force
    # This prevents the interactive prompt since we're about to remove it anyway
    STOP_ARGS_FINAL=("${STOP_ARGS[@]}")
    if [[ ! " ${STOP_ARGS_FINAL[@]} " =~ " --force " ]]; then
        STOP_ARGS_FINAL+=("--force")
    fi

    # We need to bypass the "remove now?" prompt in container-stop
    # Easiest way: set a flag or directly call docker stop + gpu release
    # Let's call docker stop directly here to avoid the nested prompts

    echo -e "${CYAN}Stopping container...${NC}"
    if docker stop -t 10 "$CONTAINER_TAG" > /dev/null 2>&1; then
        echo -e "${GREEN}âœ“${NC} Container stopped"
        echo ""
    else
        echo -e "${RED}âœ— Failed to stop container${NC}"
        exit 1
    fi
else
    echo -e "${DIM}Container already stopped, proceeding to removal...${NC}"
    echo ""
fi

# Step 2: Remove container
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
if [ "$CONTAINER_STATUS" = "running" ]; then
    echo -e "${BOLD}Step 2/2: Removing Container${NC}"
else
    echo -e "${BOLD}Removing Container${NC}"
fi
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

# Add --force to skip container-remove's confirmation (we already confirmed above)
REMOVE_ARGS_FINAL=("${REMOVE_ARGS[@]}")
if [[ ! " ${REMOVE_ARGS_FINAL[@]} " =~ " --force " ]]; then
    REMOVE_ARGS_FINAL+=("--force")
fi

if "$CONTAINER_REMOVE" "$CONTAINER_NAME" "${REMOVE_ARGS_FINAL[@]}"; then
    echo ""
    echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${GREEN}${BOLD}âœ“ Container Retired Successfully!${NC}"
    echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo -e "${BOLD}What was done:${NC}"
    if [ "$CONTAINER_STATUS" = "running" ]; then
        echo -e "  ${GREEN}âœ“${NC} Container stopped"
    fi
    echo -e "  ${GREEN}âœ“${NC} Container removed"
    echo -e "  ${GREEN}âœ“${NC} GPU released immediately"
    echo ""
    echo -e "${BOLD}Your data is safe:${NC}"
    echo -e "  ${GREEN}âœ“${NC} Workspace: ~/workspace/$CONTAINER_NAME/"
    if [[ ! " ${REMOVE_ARGS[@]} " =~ " --images " ]]; then
        echo -e "  ${GREEN}âœ“${NC} Docker image: Available for redeployment"
    fi
    echo ""
    echo -e "${BOLD}To recreate:${NC}"
    echo -e "  ${GREEN}container-deploy $CONTAINER_NAME${NC}"
    echo ""
else
    echo ""
    echo -e "${RED}âœ— Container removal failed${NC}"
    echo ""
    echo -e "${YELLOW}Try manually:${NC}"
    echo -e "  ${GREEN}container-stop $CONTAINER_NAME${NC}"
    echo -e "  ${GREEN}container-remove $CONTAINER_NAME${NC}"
    echo ""
    exit 1
fi
