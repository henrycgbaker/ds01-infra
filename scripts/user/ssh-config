#!/bin/bash
# SSH Configuration Manager for DS01
# Handles SSH key generation, testing, and configuration for VS Code Remote

BLUE='\033[94m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

USERNAME=$(whoami)
SSH_DIR="$HOME/.ssh"
KEY_FILE="$SSH_DIR/id_ed25519"
SERVER_IP=$(hostname -I | awk '{print $1}')

usage() {
    cat << EOF
${BOLD}SSH Configuration Manager${NC}

${CYAN}Usage:${NC}
  ssh-config [command]

${CYAN}Commands:${NC}
  generate    Generate new SSH keys (ed25519)
  test        Test SSH connection to localhost
  show        Display public key and connection info
  vscode      Show VS Code Remote-SSH setup instructions
  help        Show this help message

${CYAN}Examples:${NC}
  ssh-config generate    # Create new SSH keys
  ssh-config test        # Test if SSH is working
  ssh-config show        # Display your public key
  ssh-config vscode      # Get VS Code setup instructions

EOF
}

generate_keys() {
    echo -e "${CYAN}‚îÅ‚îÅ‚îÅ Generating SSH Keys ‚îÅ‚îÅ‚îÅ${NC}\n"

    if [ -f "$KEY_FILE" ]; then
        echo -e "${YELLOW}‚ö† SSH keys already exist at $KEY_FILE${NC}"
        read -p "Overwrite existing keys? [y/N]: " OVERWRITE
        if [[ ! "$OVERWRITE" =~ ^[Yy]$ ]]; then
            echo "Cancelled."
            exit 0
        fi
        echo ""
    fi

    mkdir -p "$SSH_DIR"
    chmod 700 "$SSH_DIR"

    echo "Generating ed25519 key..."
    ssh-keygen -t ed25519 -C "${USERNAME}@ds01-server" -f "$KEY_FILE" -N ""

    if [ $? -eq 0 ]; then
        echo ""
        echo -e "${GREEN}‚úì SSH keys generated successfully${NC}\n"

        # Add to authorized_keys
        cat "${KEY_FILE}.pub" >> "$SSH_DIR/authorized_keys"
        chmod 600 "$SSH_DIR/authorized_keys"

        echo -e "${GREEN}‚úì Public key added to authorized_keys${NC}\n"
        show_key
    else
        echo -e "\n${RED}‚úó Key generation failed${NC}"
        exit 1
    fi
}

test_ssh() {
    echo -e "${CYAN}‚îÅ‚îÅ‚îÅ Testing SSH Connection ‚îÅ‚îÅ‚îÅ${NC}\n"

    if [ ! -f "$KEY_FILE" ]; then
        echo -e "${RED}‚úó No SSH keys found${NC}"
        echo "Run: ssh-config generate"
        exit 1
    fi

    echo "Testing connection to localhost..."
    if ssh -o BatchMode=yes -o ConnectTimeout=5 localhost exit 2>/dev/null; then
        echo -e "${GREEN}‚úì SSH connection successful${NC}\n"
        echo "You can connect from VS Code using:"
        echo -e "  ${BLUE}ssh ${USERNAME}@${SERVER_IP}${NC}"
    else
        echo -e "${RED}‚úó SSH connection failed${NC}\n"
        echo "Troubleshooting steps:"
        echo "  1. Check if sshd is running: systemctl status sshd"
        echo "  2. Verify authorized_keys: cat ~/.ssh/authorized_keys"
        echo "  3. Check permissions: ls -la ~/.ssh/"
        exit 1
    fi
}

show_key() {
    echo -e "${CYAN}‚îÅ‚îÅ‚îÅ SSH Configuration ‚îÅ‚îÅ‚îÅ${NC}\n"

    if [ ! -f "${KEY_FILE}.pub" ]; then
        echo -e "${RED}‚úó No SSH keys found${NC}"
        echo "Run: ssh-config generate"
        exit 1
    fi

    echo -e "${BOLD}Public Key:${NC}"
    echo -e "${BLUE}$(cat ${KEY_FILE}.pub)${NC}\n"

    echo -e "${BOLD}Connection Info:${NC}"
    echo -e "  Server IP:  ${CYAN}${SERVER_IP}${NC}"
    echo -e "  Username:   ${CYAN}${USERNAME}${NC}"
    echo -e "  Key Type:   ${CYAN}ed25519${NC}"
    echo -e "  Key File:   ${CYAN}${KEY_FILE}${NC}\n"

    echo -e "${BOLD}Connect from terminal:${NC}"
    echo -e "  ${GREEN}ssh ${USERNAME}@${SERVER_IP}${NC}\n"

    echo -e "${YELLOW}üí° Tip: Use 'ssh-config vscode' for VS Code setup instructions${NC}"
}

show_vscode_setup() {
    echo -e "${CYAN}‚îÅ‚îÅ‚îÅ VS Code Remote-SSH Setup ‚îÅ‚îÅ‚îÅ${NC}\n"

    cat << VSCODEEOF
${BOLD}Step 1: Install Extensions${NC}
  In VS Code, install:
  ‚Ä¢ Remote - SSH
  ‚Ä¢ Python
  ‚Ä¢ Jupyter
  ‚Ä¢ Docker (optional)

${BOLD}Step 2: Configure SSH Connection${NC}
  1. Open Command Palette (${CYAN}Cmd/Ctrl+Shift+P${NC})
  2. Type: ${CYAN}Remote-SSH: Open SSH Configuration File${NC}
  3. Select your config file (usually ~/.ssh/config)
  4. Add this entry:

  ${BLUE}Host ds01
      HostName ${SERVER_IP}
      User ${USERNAME}
      ForwardAgent yes
      ServerAliveInterval 60
      ServerAliveCountMax 3${NC}

${BOLD}Step 3: Connect${NC}
  1. Open Command Palette (${CYAN}Cmd/Ctrl+Shift+P${NC})
  2. Type: ${CYAN}Remote-SSH: Connect to Host${NC}
  3. Select ${CYAN}ds01${NC}
  4. Wait for connection to establish

${BOLD}Step 4: Open Your Workspace${NC}
  ‚Ä¢ File ‚Üí Open Folder
  ‚Ä¢ Navigate to: ${CYAN}/home/${USERNAME}/workspace${NC}

${BOLD}Step 5: Work in Container${NC}
  Open terminal in VS Code and run:
  ${GREEN}container-run <container-name>${NC}

${YELLOW}üí° Troubleshooting:${NC}
  ‚Ä¢ Test connection first: ${CYAN}ssh-config test${NC}
  ‚Ä¢ View your key: ${CYAN}ssh-config show${NC}
  ‚Ä¢ Regenerate keys: ${CYAN}ssh-config generate${NC}

VSCODEEOF
}

# Main command router
case "${1:-help}" in
    generate)
        generate_keys
        ;;
    test)
        test_ssh
        ;;
    show)
        show_key
        ;;
    vscode)
        show_vscode_setup
        ;;
    help|-h|--help)
        usage
        ;;
    *)
        echo -e "${RED}Unknown command: $1${NC}\n"
        usage
        exit 1
        ;;
esac
